#!/usr/bin/env nix-shell
#!nix-shell -i bash -p nixFlakes git

# vim: filetype=sh
# shellcheck shell=bash
set -euo pipefail

readonly dotfiles="$(CDPATH='' cd -- "$(dirname -- "$0")/.." && pwd -P)"

# shellcheck disable=SC2154
mkdir -p "$out" # `$out` is defined by nix-shell

{
  cd "$out"
  rm -rf .git flake.{nix,lock} NIX_VERSION

  git init --quiet .

  cp -i "$dotfiles/flake.nix" "$out"
  git add flake.nix

  for file in flake.lock NIX_VERSION; do
    if [ -f "$dotfiles/$file" ]; then
      cp -i "$dotfiles/$file" "$out"
      git add "$file"
    fi
  done

  git commit --quiet -m "wip" # remove message about Git tree being dirty

  nix --experimental-features "nix-command flakes" \
    flake update --recreate-lock-file

  # `git status --porcelain` outputs nothing if no changes made
  if [ -z "$(git status --porcelain)" ]; then
    echo >&2 "No changes made"
    exit
  fi

  # Get the `nix` version for the current nixpkgs
  nix --experimental-features "nix-command flakes" \
    eval --raw ".#nixpkgs.nix.version" > NIX_VERSION

  for file in flake.lock NIX_VERSION; do
    git --no-pager diff \
      "$([ -f "$dotfiles/$file" ] && echo "$dotfiles/$file" || echo "/dev/null")" \
      "$file" || true
  done

  cp -v flake.lock NIX_VERSION "$dotfiles"
}
