#!/usr/bin/env ruby
$LOAD_PATH << File.expand_path("../rubylib", __dir__)
require "shell_lib"

class UpdateNixLockfile < ShellLib::Task
  class Lockfile < ShellLib::Path
    def as_json(**options)
      super(object_class: ShellLib::StrictHash).tap do |json|
        version = json[:version]
        raise "Unhandled version: #{version}" if version != 7
      end
    end

    def commits_for_inputs
      @commits_for_inputs ||= nodes[as_json[:root], :inputs].each_value.each_with_object({}) do |name, inputs|
        locked = nodes[name, :locked]
        next if locked[:type] != "github"

        inputs[name] = {
          slug: "#{locked[:owner]}/#{locked[:repo]}",
          commit: locked[:rev][0, 7]
        }
      end
    end

    def nodes
      @nodes ||= as_json[:nodes]
    end
  end

  def run
    Dir.chdir(DOTFILES) do
      diff do
        nix!(
          "flake",
          (inputs.any? ? "lock" : "update"),
          *inputs.map {|input| "--update-input #{input}" }
        )
      end
    end
  end

  def diff
    locked_before = lockfile.commits_for_inputs
    yield
    locked_after = lockfile.commits_for_inputs

    locked_before.each do |name, before|
      after = locked_after.fetch(name, {})

      if before[:slug] != after[:slug]
        puts "Repo changed: #{before[:slug]} -> #{after[:slug]}"
        next
      end

      next if before[:commit] == after[:commit]

      puts "#{name}: https://github.com/#{before[:slug]}/compare/#{before[:commit]}...#{after[:commit]}"
    end
  end

  private

  def inputs
    @inputs ||= argv.reject {|arg| arg.start_with?("-") }
  end

  def lockfile
    dotfiles_path("flake.lock").becomes(Lockfile)
  end

  def nix_version
    @nix_version ||= nix("eval --raw .#nixpkgs.nix.version").chomp
  end

  def args_for_nix(*args)
    args[1, 0] = "--experimental-features 'nix-command flakes'"
    args
  end
end

UpdateNixLockfile.run(ARGV) if $0 == __FILE__
